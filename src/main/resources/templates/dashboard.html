<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>Expense Manager - Track Your Spending</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .nav-links {
            margin: 20px 0;
            text-align: center;
        }
        .gamification-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
        }
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Expense Manager</h1>
        <p>Track and manage your daily expenses easily</p>
    </div>

    <div class="nav-links">
        <a th:href="@{/personal}">View All Expenses</a>
        <a th:href="@{/personal/add}">Add New Expense</a>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <h3>Today's Spending</h3>
            <p>₹<span th:text="${#numbers.formatDecimal(todayTotal, 1, 2)}">0</span></p>
        </div>
        <div class="stat-card">
            <h3>This Week</h3>
            <p>₹<span th:text="${#numbers.formatDecimal(weeklyTotal, 1, 2)}">0</span></p>
        </div>
        <div class="stat-card">
            <h3>This Month</h3>
            <p>₹<span th:text="${#numbers.formatDecimal(monthTotal, 1, 2)}">0</span></p>
        </div>
        <div class="stat-card">
            <h3>Total Expenses</h3>
            <p th:text="${totalExpenses}">0</p>
        </div>
    </div>

    <!-- Gamification Section -->
    <div class="gamification-section">
        <h2>Your Progress</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Level</h3>
                <p th:text="${userStats.currentLevel}">1</p>
            </div>
            <div class="stat-card">
                <h3>Points</h3>
                <p th:text="${totalPoints}">0</p>
            </div>
            <div class="stat-card">
                <h3>Achievements</h3>
                <p><span th:text="${unlockedAchievementsCount}">0</span>/8</p>
            </div>
            <div class="stat-card">
                <h3>Streak</h3>
                <p><span th:text="${userStats.consecutiveTrackingDays}">0</span> days</p>
            </div>
        </div>

        <div class="nav-links">
            <a th:href="@{/gamification/achievements}">View All Achievements</a>
            <a th:href="@{/gamification/leaderboard}">View Progress</a>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>Spending by Category (This Month)</h3>
            <canvas id="categoryChart" width="400" height="300"></canvas>
        </div>
        <div class="chart-container">
            <h3>Monthly Spending Trend</h3>
            <canvas id="trendChart" width="400" height="300"></canvas>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const catMap = /*[[${categorySums}]]*/ {};
    const categoryLabels = Object.keys(catMap || {});
    const categoryData = Object.values(catMap || {});

    if (categoryLabels.length > 0 && categoryData.some(val => val > 0)) {
        const categoryCtx = document.getElementById('categoryChart').getContext('2d');
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: [
                        '#e74c3c', '#3498db', '#f39c12', '#9b59b6',
                        '#1abc9c', '#d35400', '#34495e', '#7f8c8d'
                    ]
                }]
            }
        });
    } else {
        document.getElementById('categoryChart').innerHTML =
            '<p>No expenses recorded for this month. <a href="/personal/add">Add your first expense!</a></p>';
    }

    // Trend Chart
    const trendMap = /*[[${monthlyTrends}]]*/ {};
    const trendLabels = Object.keys(trendMap || {});
    const trendData = Object.values(trendMap || {});

    if (trendLabels.length > 0 && trendData.some(val => val > 0)) {
        const trendCtx = document.getElementById('trendChart').getContext('2d');
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{
                    label: 'Monthly Spending',
                    data: trendData,
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    borderWidth: 2,
                    fill: true
                }]
            }
        });
    } else {
        document.getElementById('trendChart').innerHTML =
            '<p>Not enough data for trend analysis.</p>';
    }
    /*]]>*/
</script>
</body>
</html>